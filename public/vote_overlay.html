<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chzzk Bot - Real-time Overlay</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;900&family=Noto+Sans+KR:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00ff94;
            --bg-opacity: 0.7;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background: transparent;
        }
        #overlay-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
        }
        .vote-box {
            background: rgba(15, 15, 20, var(--bg-opacity));
            border: 2px solid var(--primary-color);
            border-radius: 24px;
            padding: 30px;
            min-width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            color: white;
            animation: slide-up 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes slide-up { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .vote-title { font-size: 1.8rem; margin-bottom: 25px; text-align: center; font-weight: 900; }
        .vote-opt { margin-bottom: 15px; }
        .opt-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 700; }
        .progress-bg { background: rgba(255,255,255,0.1); height: 12px; border-radius: 10px; overflow: hidden; }
        .progress-fill { background: var(--primary-color); height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 15px var(--primary-color); }
        
        .winner-announce {
            font-size: 3rem;
            color: white;
            text-align: center;
            text-shadow: 0 0 20px var(--primary-color);
            animation: bounce 1s infinite alternate;
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }
    </style>
</head>
<body>
    <div id="overlay-container">
        <div id="content-area"></div>
    </div>

    <script>
        let socket = null;
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        function updateStyles(settings) {
            if (!settings) return;
            document.documentElement.style.setProperty('--primary-color', settings.themeColor || '#00ff94');
            document.documentElement.style.setProperty('--bg-opacity', (settings.backgroundOpacity || 70) / 100);
        }

        function initWebSocket() {
            if (!token) return;
            const wsUrl = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/?token=${token}`;
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                socket.send(JSON.stringify({ type: 'connect' }));
                socket.send(JSON.stringify({ type: 'requestData' }));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'voteStateUpdate') renderVote(data.payload.currentVote);
                if (data.type === 'overlaySettingsUpdate') updateStyles(data.payload);
                if (data.type === 'drawWinnerResult') showWinner(data.payload.winners);
            };

            socket.onclose = () => setTimeout(initWebSocket, 5000);
        }

        function renderVote(vote) {
            const area = document.getElementById('content-area');
            if (!vote || !vote.isActive) { area.innerHTML = ''; return; }
            const total = Object.values(vote.results).reduce((a,b) => a+b, 0);
            let html = `<div class="vote-box"><div class="vote-title">${vote.question}</div>`;
            vote.options.forEach(opt => {
                const pct = total > 0 ? Math.round(((vote.results[opt.id] || 0)/total)*100) : 0;
                html += `<div class="vote-opt"><div class="opt-label"><span>${opt.text}</span><span>${pct}%</span></div><div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div></div>`;
            });
            area.innerHTML = html + '</div>';
        }

        function showWinner(winners) {
            const area = document.getElementById('content-area');
            confetti({ particleCount: 200, spread: 90, origin: { y: 0.7 } });
            area.innerHTML = `<div class="winner-announce">ðŸŽ‰ ${winners[0].nickname} ë‹¹ì²¨!</div>`;
            setTimeout(() => area.innerHTML = '', 5000);
        }

        initWebSocket();
    </script>
</body>
</html>
