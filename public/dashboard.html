<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chzzk Bot Dashboard - Ultimate Fixed</title>
    <script src="/config.js"></script>
    <script src="/api-adapter.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/modern-ui.css">
    <link rel="stylesheet" href="/vote-ui-enhanced.css">
    <link rel="stylesheet" href="/toggle.css">
    <style>
        .flex-row-group { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start; margin-bottom: 24px; }
        @media (max-width: 1024px) { .flex-row-group { grid-template-columns: 1fr; } }
        .current-song-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #current-song-thumbnail { width: 100%; max-width: 320px; aspect-ratio: 16/9; border-radius: 12px; background: #000; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
        .mt-20 { margin-top: 20px; }
        .btn-block { width: 100%; }
    </style>
</head>
<body>
    <div class="background-wrapper"><div class="blob"></div><div class="blob"></div><div class="blob"></div></div>
    <div class="noise-overlay"></div>

    <header class="header">
        <div class="header-left">
            <button class="sidebar-toggle" id="sidebar-toggle"><i class="fas fa-bars"></i></button>
            <h1 class="header-title" id="header-title">대시보드</h1>
        </div>
        <div class="header-right" id="header-profile" style="display: none;">
            <div class="header-profile-info">
                <div class="header-avatar" id="header-avatar" style="width:32px; height:32px; border-radius:50%; background-size:cover; border:1px solid #00ff94;"></div>
                <span class="header-username" id="header-username"></span>
            </div>
            <button class="header-logout" onclick="DashboardApp.handleLogout()" title="로그아웃"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-profile" id="sidebar-profile" style="display: none;">
                <div class="sidebar-avatar" id="sidebar-avatar" style="width:48px; height:48px; border-radius:12px; background-size:cover; border:2px solid #00ff94;"></div>
                <div class="sidebar-info">
                    <div class="sidebar-name" id="sidebar-name">사용자</div>
                    <div class="sidebar-status"><span class="status-dot"></span><span id="sidebar-status-text">연결됨</span></div>
                </div>
            </div>
            <div class="bot-status">
                <div class="status-indicator" id="bot-status-indicator"></div><span id="bot-status-text">봇 미연결</span>
                <label class="toggle-switch small" style="margin-left: auto;" title="봇 활성화"><input type="checkbox" id="bot-chat-toggle" checked><span class="slider round"></span></label>
            </div>
        </div>
        <nav class="sidebar-nav">
            <ul class="nav-list">
                <li class="nav-item active" data-tab="dashboard"><i class="fas fa-home"></i><span>대시보드</span></li>
                <li class="nav-item" data-tab="commands"><i class="fas fa-terminal"></i><span>명령어</span></li>
                <li class="nav-item" data-tab="macros"><i class="fas fa-clock"></i><span>매크로</span></li>
                <li class="nav-item" data-tab="counters"><i class="fas fa-calculator"></i><span>카운터</span></li>
                <li class="nav-item" data-tab="songs"><i class="fas fa-music"></i><span>신청곡</span></li>
                <li class="nav-item" data-tab="greet"><i class="fas fa-hand-sparkles"></i><span>인사</span></li>
                <li class="nav-item" data-tab="votes"><i class="fas fa-poll"></i><span>투표/추첨</span></li>
                <li class="nav-item" data-tab="participation"><i class="fas fa-users"></i><span>참여</span></li>
                <li class="nav-item" data-tab="points"><i class="fas fa-coins"></i><span>포인트</span></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <button class="logout-btn" id="logout-btn" onclick="DashboardApp.handleLogout()"><i class="fas fa-sign-out-alt"></i><span>로그아웃</span></button>
        </div>
    </aside>

    <main class="main-content">
        <!-- 1. Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card channel-card">
                    <div class="channel-info">
                        <div class="channel-avatar" id="main-channel-avatar" style="width:60px; height:60px; border-radius:15px; background-size:cover; border:2px solid #00ff94;"></div>
                        <div class="channel-details">
                            <h2 class="channel-name" id="channel-name">채널명</h2>
                            <div class="channel-stats"><span id="follower-count"><i class="fas fa-heart"></i><span> 0 팔로워</span></span></div>
                        </div>
                    </div>
                    <div class="stream-info">
                        <div class="stream-status" id="stream-status-box"><span class="status-badge offline">OFFLINE</span><span class="viewer-count" id="viewer-count">0명</span></div>
                        <div class="stream-title" id="stream-title">-</div>
                        <div class="stream-category" id="stream-category"><i class="fas fa-gamepad"></i><span> -</span></div>
                    </div>
                </div>
                <div class="card stats-card">
                    <h3 class="card-title">실시간 현황</h3>
                    <div class="stats-grid">
                        <div class="stat-item"><div class="stat-value" id="stat-commands">0</div><div class="stat-label">명령어</div></div>
                        <div class="stat-item"><div class="stat-value" id="stat-songs">0</div><div class="stat-label">신청곡</div></div>
                        <div class="stat-item"><div class="stat-value" id="stat-votes">0</div><div class="stat-label">투표</div></div>
                        <div class="stat-item"><div class="stat-value" id="stat-participants">0</div><div class="stat-label">참여자</div></div>
                    </div>
                </div>
                <div class="card chat-card">
                    <div class="card-header"><h3 class="card-title">실시간 채팅</h3></div>
                    <div class="chat-messages" id="chat-messages"><div class="chat-empty">채팅이 없습니다</div></div>
                </div>
            </div>
        </div>

        <div id="commands-tab" class="tab-content">
            <div class="tab-header"><h2>명령어 관리</h2><button class="btn btn-primary" onclick="DashboardApp.utils.modal('add-command-modal')">추가</button></div>
            <div class="card"><div id="commands-list" class="item-list"></div></div>
        </div>
        <div id="macros-tab" class="tab-content">
            <div class="tab-header"><h2>매크로 관리</h2><button class="btn btn-primary" onclick="DashboardApp.utils.modal('add-macro-modal')">추가</button></div>
            <div class="card"><div id="macros-list" class="item-list"></div></div>
        </div>
        <div id="counters-tab" class="tab-content">
            <div class="tab-header"><h2>카운터 관리</h2><button class="btn btn-primary" onclick="DashboardApp.utils.modal('add-counter-modal')">추가</button></div>
            <div class="card"><div id="counters-list" class="item-list"></div></div>
        </div>

        <div id="songs-tab" class="tab-content">
            <div class="tab-header"><h2>신청곡 관리</h2></div>
            <div class="songs-grid">
                <div class="card current-song-card">
                    <h3>현재 재생</h3>
                    <div class="current-song-container">
                        <img id="current-song-thumbnail" src="" alt="Thumbnail">
                        <div id="current-song" style="font-weight: 800; font-size: 1.1rem; text-align: center;">재생 중인 곡 없음</div>
                        <div class="player-controls">
                            <button class="btn btn-primary" onclick="DashboardApp.send({type:'controlMusic',action:'togglePlayPause'})"><i class="fas fa-play"></i></button>
                            <button class="btn btn-secondary" onclick="DashboardApp.send({type:'controlMusic',action:'skip'})"><i class="fas fa-step-forward"></i></button>
                        </div>
                    </div>
                </div>
                <div class="card"><h3>대기열 <span class="badge" id="queue-count">0</span></h3><div id="song-queue-list"></div></div>
            </div>
            <div class="card mt-20">
                <div class="card-header"><h3>신청곡 설정</h3><button class="btn btn-primary btn-sm" onclick="DashboardApp.saveSongSettings()">저장</button></div>
                <div class="settings-grid mt-20">
                    <div class="setting-item" style="grid-column: span 3;"><label>신청 모드</label>
                        <div class="radio-group">
                            <label class="radio-label"><input type="radio" name="songRequestMode" value="all"><span>전체 허용</span></label>
                            <label class="radio-label"><input type="radio" name="songRequestMode" value="cooldown"><span>쿨타임</span></label>
                            <label class="radio-label"><input type="radio" name="songRequestMode" value="donation"><span>후원 전용</span></label>
                            <label class="radio-label"><input type="radio" name="songRequestMode" value="off"><span>비활성화</span></label>
                        </div>
                    </div>
                    <div class="setting-item"><label>쿨타임(초)</label><input type="number" id="song-cooldown" class="form-input"></div>
                    <div class="setting-item"><label>최소 후원금</label><input type="number" id="song-min-donation" class="form-input"></div>
                    <div class="setting-item"><label>플레이어</label><button class="btn btn-secondary btn-block" onclick="DashboardApp.openPlayer()"><i class="fas fa-external-link-alt"></i> 플레이어 열기</button></div>
                </div>
            </div>
        </div>

        <div id="greet-tab" class="tab-content">
            <div class="tab-header"><h2>인사 설정</h2><button class="btn btn-primary" onclick="DashboardApp.saveGreetSettings()">설정 저장</button></div>
            <div class="card mt-20">
                <div class="settings-box">
                    <div class="box-label">인사 방식 선택</div>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="greetType" value="1" checked><span>최초 1회</span></label>
                        <label class="radio-label"><input type="radio" name="greetType" value="2"><span>매일마다</span></label>
                    </div>
                </div>
                <div class="flex-row-group mt-30">
                    <div class="card" style="padding:20px; cursor:pointer;" onclick="DashboardApp.utils.modal('edit-greet-modal')">
                        <div style="color:#888; font-size:0.9rem; margin-bottom:10px;">새로운 채팅을 보면</div>
                        <div id="display-greet-msg" style="font-weight:700; color:#00ff94;">방송에 오신 것을 환영합니다!</div>
                        <div style="color:#555; font-size:0.8rem; margin-top:10px;">클릭하여 문구 수정 <i class="fas fa-pen"></i></div>
                    </div>
                    <div class="card" style="padding:20px; text-align:center;">
                        <div style="font-size:2rem; font-weight:900; color:#00ff94" id="greet-history-count">0명</div>
                        <p style="color:#888;">을 기억하고 있어요!</p>
                        <button class="btn btn-danger btn-sm mt-10 btn-block" onclick="DashboardApp.resetGreetHistory()">기록 초기화</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="votes-tab" class="tab-content">
            <div class="vote-tabs">
                <button class="vote-sub-tab active" data-vote-subtab="draw">추첨</button>
                <button class="vote-sub-tab" data-vote-subtab="vote">투표</button>
                <button class="vote-sub-tab" data-vote-subtab="roulette">룰렛</button>
                <button class="vote-sub-tab" data-vote-subtab="settings">설정</button>
            </div>
            <div id="draw-subtab" class="vote-subtab active">
                <div class="flex-row-group mt-20">
                    <div class="card"><h3>추첨 설정</h3>
                        <div class="form-group"><label>참여 키워드</label><input type="text" id="draw-keyword" class="form-input" value="!참여"></div>
                        <div class="form-group"><label>당첨 인원</label><input type="number" id="draw-winner-count" class="form-input" value="1"></div>
                        <div class="btn-group mt-20">
                            <button class="btn btn-primary" id="start-draw-btn" onclick="window.startDraw()">시작</button>
                            <button class="btn btn-warning" id="stop-draw-btn" style="display:none;" onclick="window.stopDrawCollecting()">마감</button>
                            <button class="btn btn-success" id="execute-draw-btn" style="display:none;" onclick="window.executeDraw()">추첨</button>
                            <button class="btn btn-secondary" onclick="window.resetDraw()">초기화</button>
                        </div>
                    </div>
                    <div class="card"><h3>참여자 명단 (<span id="draw-participant-count">0</span>)</h3><div id="draw-participants" class="participant-list"></div></div>
                </div>
            </div>
            <div id="vote-subtab" class="vote-subtab">
                <div class="flex-row-group mt-20">
                    <div class="card"><h3>투표 생성</h3>
                        <div class="form-group"><label>질문</label><input type="text" id="vote-question" class="form-input"></div>
                        <div id="vote-options-container">
                            <div class="vote-option-item"><input type="text" class="form-input" placeholder="항목 1"></div>
                            <div class="vote-option-item"><input type="text" class="form-input" placeholder="항목 2"></div>
                        </div>
                        <button class="btn-sm mt-10" onclick="window.addVoteOption()">+ 항목 추가</button>
                        <button class="btn btn-primary mt-20 btn-block" onclick="window.createVote()">투표 시작</button>
                    </div>
                    <div class="card"><h3>결과</h3><div id="current-vote-display"></div><div id="vote-controls" style="display:none" class="mt-20"><button class="btn btn-danger btn-block" onclick="window.endVote()">종료</button><button class="btn btn-secondary btn-block mt-10" onclick="window.resetVote()">초기화</button></div></div>
                </div>
            </div>
            <div id="roulette-subtab" class="vote-subtab">
                <div class="flex-row-group mt-20">
                    <div class="card"><h3>룰렛 설정</h3><div id="roulette-items-container">
                        <div class="vote-option-item"><input type="text" class="form-input" value="항목 1"><input type="number" class="form-input" style="width:70px" value="1"></div>
                        <div class="vote-option-item"><input type="text" class="form-input" value="항목 2"><input type="number" class="form-input" style="width:70px" value="1"></div>
                    </div><button class="btn-sm" onclick="window.addRouletteItem()">+ 추가</button><button class="btn btn-primary mt-20 btn-block" onclick="window.createRoulette()">룰렛 생성</button></div>
                    <div class="card"><h3>룰렛</h3><div id="roulette-container"></div><button class="btn btn-primary mt-20 btn-block" id="spin-roulette-btn" style="display:none" onclick="window.spinRoulette()">돌리기!</button><button class="btn btn-secondary mt-10 btn-block" onclick="window.resetRoulette()">룰렛 초기화</button></div>
                </div>
            </div>
            <div id="settings-subtab" class="vote-subtab">
                <div class="card mt-20"><h3>오버레이</h3>
                    <div class="form-group"><label>오버레이 URL</label><div class="input-group"><input type="text" id="overlay-url" class="form-input" readonly><button class="btn btn-primary" onclick="DashboardApp.copyOverlayUrl()">복사</button></div></div>
                    <div class="form-group"><label>배경 투명도</label><input type="range" id="overlay-opacity" min="0" max="100" class="form-slider" oninput="DashboardApp.syncRangeValue(this, 'overlay-opacity-value')"><span id="overlay-opacity-value">70%</span></div>
                    <div class="form-group"><label>결과 시간</label><input type="range" id="overlay-auto-hide" min="3" max="20" class="form-slider" oninput="DashboardApp.syncRangeValue(this, 'overlay-auto-hide-value')"><span id="overlay-auto-hide-value">5초</span></div>
                    <button class="btn btn-primary mt-20 btn-block" onclick="DashboardApp.saveOverlaySettings()">저장</button>
                </div>
            </div>
        </div>

        <div id="participation-tab" class="tab-content">
            <div class="card mb-20">
                <div class="card-header"><h3>참여 설정</h3><button class="btn btn-primary btn-sm" onclick="DashboardApp.saveParticipationSettings()">저장</button></div>
                <div class="flex-row-group mt-20">
                    <div class="form-group"><label>참여 명령어</label><input type="text" id="participation-command" class="form-input" value="!시참 참여"></div>
                    <div class="form-group"><label>최대 인원 (<span id="max-participants-value">10</span>명)</label><input type="range" id="max-participants-slider" min="1" max="100" class="form-slider" oninput="document.getElementById('max-participants-value').textContent=this.value"></div>
                </div>
                <div class="btn-group mt-20">
                    <button class="btn btn-primary" id="toggle-participation-btn" onclick="DashboardApp.toggleParticipation()">참여 시작</button>
                    <button class="btn btn-danger" onclick="DashboardApp.clearParticipants()">데이터 초기화</button>
                </div>
            </div>
            <div class="flex-row-group">
                <div class="card"><h3>대기열 (<span id="waiting-count">0</span>)</h3><div id="waiting-queue" class="item-list"></div></div>
                <div class="card"><h3>참여 중 (<span id="active-count">0</span>)</h3><div id="active-participants" class="item-list"></div></div>
            </div>
        </div>

        <div id="points-tab" class="tab-content">
            <div class="flex-row-group">
                <div class="card"><h3>포인트 설정</h3>
                    <div class="form-group"><label>지급 포인트</label><input type="number" id="points-per-chat" class="form-input"></div>
                    <div class="form-group"><label>지급 쿨타임(초)</label><input type="number" id="points-cooldown" class="form-input"></div>
                    <div class="form-group"><label>단위 이름</label><input type="text" id="points-unit-name" class="form-input" placeholder="포인트"></div>
                    <button class="btn btn-primary mt-20 btn-block" onclick="DashboardApp.savePointsSettings()">저장</button>
                </div>
                <div class="card"><h3>랭킹</h3><div id="points-ranking" class="item-list"></div></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="add-command-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h2>명령어 설정</h2><button class="modal-close" onclick="DashboardApp.utils.modal('add-command-modal', false)">×</button></div>
            <div class="modal-body">
                <div class="form-group"><label>트리거</label><input type="text" id="new-command-trigger" class="form-input"></div>
                <div class="form-group"><label>응답 내용</label><textarea id="new-command-response" class="form-textarea" oninput="DashboardApp.updatePreview('new-command-response','cmd-preview')"></textarea></div>
                <div class="form-group"><label>함수 칩</label>
                    <div class="function-chips">
                        <span class="fn-chip" onclick="DashboardApp.insertFunction('new-command-response','/user')">/user</span>
                        <span class="fn-chip" onclick="DashboardApp.insertFunction('new-command-response','/uptime')">/uptime</span>
                        <span class="fn-chip" onclick="DashboardApp.insertFunction('new-command-response','/viewer')">/viewer</span>
                        <span class="fn-chip" onclick="DashboardApp.insertFunction('new-command-response','/random')">/random</span>
                        <span class="fn-chip" onclick="DashboardApp.insertFunction('new-command-response','/since')">/since</span>
                        <span class="fn-chip" onclick="DashboardApp.insertFunction('new-command-response','/count')">/count</span>
                    </div>
                </div>
                <div class="preview-box" id="cmd-preview">봇: 응답 예시...</div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="DashboardApp.addCommand()">저장</button></div>
        </div>
    </div>

    <div id="add-macro-modal" class="modal-overlay"><div class="modal"><div class="modal-header"><h2>매크로 설정</h2><button class="modal-close" onclick="DashboardApp.utils.modal('add-macro-modal', false)">×</button></div><div class="modal-body"><div class="form-group"><label>간격(분)</label><input type="number" id="new-macro-interval" class="form-input" value="10"></div><div class="form-group"><label>메시지</label><textarea id="new-macro-message" class="form-textarea" oninput="DashboardApp.updatePreview('new-macro-message','macro-preview')"></textarea></div><div class="preview-box" id="macro-preview">미리보기...</div></div><div class="modal-footer"><button class="btn btn-primary" onclick="DashboardApp.addMacro()">저장</button></div></div></div>
    <div id="add-counter-modal" class="modal-overlay"><div class="modal"><div class="modal-header"><h2>카운터 설정</h2><button class="modal-close" onclick="DashboardApp.utils.modal('add-counter-modal', false)">×</button></div><div class="modal-body"><div class="form-group"><label>트리거</label><input type="text" id="new-counter-trigger" class="form-input"></div><div class="form-group"><label>응답</label><textarea id="new-counter-response" class="form-textarea" oninput="DashboardApp.updatePreview('new-counter-response','counter-preview')"></textarea></div><div class="form-group" style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px;"><label style="margin:0">하루 한 번만 실행</label><label class="toggle-switch small"><input type="checkbox" id="new-counter-once"><span class="slider round"></span></label></div><div class="preview-box mt-20" id="counter-preview">미리보기...</div></div><div class="modal-footer"><button class="btn btn-primary" onclick="DashboardApp.addCounter()">저장</button></div></div></div>
    <div id="edit-greet-modal" class="modal-overlay"><div class="modal"><div class="modal-header"><h2>인사 문구 수정</h2><button class="modal-close" onclick="DashboardApp.utils.modal('edit-greet-modal', false)">×</button></div><div class="modal-body"><div class="form-group"><label>인사 메시지</label><textarea id="edit-greet-input" class="form-textarea" rows="4" oninput="DashboardApp.updatePreview('edit-greet-input','greet-preview')"></textarea></div><div class="preview-box" id="greet-preview">봇: 응답 예시...</div></div><div class="modal-footer"><button class="btn btn-primary" onclick="DashboardApp.saveGreetEditor()">적용</button></div></div></div>

    <div id="notification-container"></div>
    <script src="/dashboard.js"></script>
    <script src="/vote-system.js"></script>
</body>
</html>